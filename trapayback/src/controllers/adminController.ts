import { Request, Response, NextFunction } from 'express';
import { AdminService } from '../services/adminService';
import { PaymentLinkService } from '../services/paymentLinkService'; // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
import { telegramBotService } from '../services/telegramBotService';
import { UpdateUserRequest } from '../types/user';
import { MerchantsAwaitingPayoutFilters, CreatePayoutRequest, PayoutFilters } from '../types/admin';

export class AdminController {
  private adminService: AdminService;
  private paymentLinkService: PaymentLinkService; // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û

  constructor() {
    this.adminService = new AdminService();
    this.paymentLinkService = new PaymentLinkService(); // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
  }

  // GET /api/admin/auth - Check if user is admin
  checkAuth = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const user = req.user;
      
      // If we reach here, the user is authenticated and is an admin
      // (thanks to requireAdmin middleware)
      res.json({
        success: true,
        message: 'Admin access confirmed',
        user: {
          id: user?.id,
          username: user?.username,
          role: user?.role,
        },
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/statistics - Get system statistics
  getStatistics = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { period = '30d' } = req.query;
      const statistics = await this.adminService.getSystemStatistics(period as string);
      
      res.json({
        success: true,
        result: statistics,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/payout/stats - Get payout statistics
  getPayoutStats = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const stats = await this.adminService.getPayoutStats();
      
      res.json({
        success: true,
        result: stats,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/payout/merchants - Get merchants awaiting payout
  getMerchantsAwaitingPayout = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { 
        page = 1, 
        limit = 20, 
        minAmount,
        search
      } = req.query;

      const filters: MerchantsAwaitingPayoutFilters = {
        page: Number(page),
        limit: Number(limit),
        minAmount: minAmount ? Number(minAmount) : undefined,
        search: search as string,
      };

      const result = await this.adminService.getMerchantsAwaitingPayout(filters);
      
      res.json({
        success: true,
        merchants: result.merchants,
        pagination: result.pagination,
        summary: result.summary,
      });
    } catch (error) {
      next(error);
    }
  };

  // POST /api/admin/payout - Create new payout
  createPayout = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const payoutData: CreatePayoutRequest = req.body;
      const result = await this.adminService.createPayout(payoutData);
      
      res.status(201).json({
        success: true,
        message: 'Payout created successfully',
        result: result,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/payouts - Get all payouts with pagination and filters
  getPayouts = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { 
        page = 1, 
        limit = 20, 
        shopId,
        network,
        dateFrom,
        dateTo,
        search
      } = req.query;

      const filters: PayoutFilters = {
        page: Number(page),
        limit: Number(limit),
        shopId: shopId as string,
        network: network as string,
        dateFrom: dateFrom as string,
        dateTo: dateTo as string,
        search: search as string,
      };

      const result = await this.adminService.getAllPayouts(filters);
      
      res.json({
        success: true,
        payouts: result.payouts,
        pagination: result.pagination,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/payouts/:id - Get payout by ID
  getPayoutById = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      const payout = await this.adminService.getPayoutById(id);
      
      if (!payout) {
        return res.status(404).json({
          success: false,
          message: 'Payout not found',
        });
      }

      res.json({
        success: true,
        result: payout,
      });
    } catch (error) {
      next(error);
    }
  };

  // DELETE /api/admin/payouts/:id - Delete payout
  deletePayout = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      await this.adminService.deletePayout(id);
      
      res.json({
        success: true,
        message: 'Payout deleted successfully',
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/payments - Get all payments with pagination and filters
  getPayments = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { 
        page = 1, 
        limit = 20, 
        status,
        gateway,
        shopId,
        dateFrom,
        dateTo,
        search
      } = req.query;

      const filters = {
        page: Number(page),
        limit: Number(limit),
        status: status as string,
        gateway: gateway as string,
        shopId: shopId as string,
        dateFrom: dateFrom as string,
        dateTo: dateTo as string,
        search: search as string,
      };

      const result = await this.adminService.getAllPayments(filters);
      
      res.json({
        success: true,
        payments: result.payments,
        pagination: result.pagination,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/payments/:id - Get payment by ID
  getPaymentById = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      const payment = await this.adminService.getPaymentById(id);
      
      if (!payment) {
        return res.status(404).json({
          success: false,
          message: 'Payment not found',
        });
      }

      res.json({
        success: true,
        result: payment,
      });
    } catch (error) {
      next(error);
    }
  };

  // ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û: PUT /api/admin/payments/:id - Update payment status without mentioning admin
  updatePayment = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      const { status, notes, chargebackAmount } = req.body;
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–ª–∞—Ç–µ–∂ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
      const paymentBefore = await this.adminService.getPaymentById(id);
      
      if (!paymentBefore) {
        return res.status(404).json({
          success: false,
          message: 'Payment not found',
        });
      }

      const result = await this.adminService.updatePaymentStatus(id, status, notes, chargebackAmount);
      
      // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º payment link –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ PAID
      if (paymentBefore.status !== status && status.toUpperCase() === 'PAID') {
        console.log(`üìà Admin changed payment ${id} to PAID, updating payment link counter`);
        
        try {
          await this.paymentLinkService.handleSuccessfulPayment(id);
          console.log(`‚úÖ Payment link counter updated for payment ${id}`);
        } catch (linkError) {
          console.error('Failed to update payment link counter:', linkError);
          // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å
        }
      }

      // ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–¥–º–∏–Ω–∞
      if (paymentBefore.status !== status) {
        console.log(`üì± Payment ${id} status changed from ${paymentBefore.status} to ${status}, sending Telegram notification`);
        
        try {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è Telegram
          let telegramStatus: 'paid' | 'failed' | 'expired' | 'refund' | 'chargeback' | 'processing';
          
          switch (status.toUpperCase()) {
            case 'PAID':
              telegramStatus = 'paid';
              break;
            case 'PROCESSING':
              telegramStatus = 'processing';
              break;
            case 'FAILED':
              telegramStatus = 'failed';
              break;
            case 'EXPIRED':
              telegramStatus = 'expired';
              break;
            case 'REFUND':
              telegramStatus = 'refund';
              break;
            case 'CHARGEBACK':
              telegramStatus = 'chargeback';
              break;
            default:
              // –î–ª—è PENDING –∏ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
              console.log(`üì± Skipping Telegram notification for status change to: ${status}`);
              break;
          }

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
          if (telegramStatus!) {
            // ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û: –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–¥–º–∏–Ω–∞
            const paymentForNotification = {
              ...result,
              shopId: paymentBefore.shopId,
              gateway: paymentBefore.gateway,
              createdAt: paymentBefore.createdAt,
              // ‚úÖ –£–ë–†–ê–ù–û: –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–∞–Ω–æ –∞–¥–º–∏–Ω–æ–º
              chargebackAmount: chargebackAmount,
            };

            await telegramBotService.sendPaymentNotification(
              paymentBefore.shopId, 
              paymentForNotification, 
              //@ts-ignore
              telegramStatus
            );

            console.log(`‚úÖ Telegram notification sent for status change: ${paymentBefore.status} -> ${status}`);
          }
        } catch (telegramError) {
          console.error('Failed to send Telegram notification for status change:', telegramError);
          // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å
        }
      }
      
      res.json({
        success: true,
        message: 'Payment updated successfully',
        result: result,
      });
    } catch (error) {
      next(error);
    }
  };

  // PUT /api/admin/users/:id - Update user by admin
  updateUser = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      const updateData: UpdateUserRequest = req.body;
      
      const result = await this.adminService.updateUser(id, updateData);
      
      res.json({
        success: true,
        message: 'User updated successfully',
        result: result,
      });
    } catch (error) {
      next(error);
    }
  };

  // POST /api/admin/users/:id/suspend - Suspend user
  suspendUser = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      
      const result = await this.adminService.suspendUser(id);
      
      res.json({
        success: true,
        message: 'User suspended successfully',
        result: result,
      });
    } catch (error) {
      next(error);
    }
  };

  // POST /api/admin/users/:id/activate - Activate user (unsuspend)
  activateUser = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      
      const result = await this.adminService.activateUser(id);
      
      res.json({
        success: true,
        message: 'User activated successfully',
        result: result,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/users - Get all users with pagination and filters
  getUsers = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { 
        page = 1, 
        limit = 20, 
        status 
      } = req.query;

      const filters = {
        page: Number(page),
        limit: Number(limit),
        status: status as string,
      };

      const result = await this.adminService.getAllUsers(filters);
      
      res.json({
        success: true,
        users: result.users,
        pagination: result.pagination,
      });
    } catch (error) {
      next(error);
    }
  };

  // GET /api/admin/users/:id - Get user by ID
  getUserById = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      const user = await this.adminService.getUserById(id);
      
      if (!user) {
        return res.status(404).json({
          success: false,
          message: 'User not found',
        });
      }

      res.json({
        success: true,
        result: user,
      });
    } catch (error) {
      next(error);
    }
  };

  // POST /api/admin/users - Create new user
  createUser = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const userData = req.body;
      const result = await this.adminService.createUser(userData);
      
      res.status(201).json({
        success: true,
        message: 'User created successfully',
        result: result,
      });
    } catch (error) {
      next(error);
    }
  };

  // DELETE /api/admin/users/:id - Delete user
  deleteUser = async (req: Request, res: Response, next: NextFunction) => {
    try {
      const { id } = req.params;
      await this.adminService.deleteUser(id);
      
      res.json({
        success: true,
        message: 'User deleted successfully',
      });
    } catch (error) {
      next(error);
    }
  };
}